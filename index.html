<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Engini - Choose your AI Worker</title>
  <link rel="icon" type="image/png" href="image.png"/>
  <style>
    /* =========================
       Light Glassmorphism Theme
    ========================== */
    :root{
      --bg:#f6f8fb;
      --ink:#0b1220;
      --muted:#64748b;

      --glass:rgba(255,255,255,.72);
      --glass-strong:rgba(255,255,255,.86);
      --line:rgba(15, 23, 42, .09);
      --line-strong:rgba(15, 23, 42, .16);

      --primary:#1677ff;
      --primary-ink:#ffffff;
      --ring:rgba(22,119,255,.18);
      --success:#0bb07b;

      --chip:#f1f5ff;
      --chip-ink:#1f2937;

      --shadow:0 14px 36px rgba(15,23,42,.10);
      --shadow-sm:0 10px 26px rgba(15,23,42,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:14px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at -10% -20%, rgba(22,119,255,.08), transparent 40%),
        radial-gradient(900px 500px at 110% -10%, rgba(2,132,199,.10), transparent 40%),
        radial-gradient(#dde6f5 1px, transparent 1px) 0 0 / 18px 18px,
        #f7f9fc;
      background-attachment:fixed;
    }
    .container{max-width:1120px;margin:0 auto;padding:0 20px}

    /* Header / Progress */
    .header{
      position:sticky;top:0;z-index:50;
      background:var(--glass);backdrop-filter:saturate(1.2) blur(8px);
      border-bottom:1px solid var(--line);
    }
    .header-inner{display:flex;align-items:center;justify-content:space-between;height:64px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px}
    .brand img{height:26px;width:auto}
    .progress{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:700}
    .progress .dot{display:inline-block;width:18px;height:18px;border:2px solid var(--line);border-radius:999px;vertical-align:-4px;background:#fff}
    .progress .active .dot{background:var(--primary);border-color:var(--primary)}
    .progress span{display:flex;align-items:center;gap:6px}
    .cta-sales{height:36px;padding:0 14px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--ink);cursor:pointer;font-weight:800}
    .cta-sales:hover{box-shadow:var(--shadow-sm);border-color:var(--line-strong)}

    /* Head */
    .h1{font-size:30px;line-height:1.2;margin:22px 0 6px;text-align:center}
    .muted{color:var(--muted)}
    .lead{max-width:720px;margin:0 auto 12px;text-align:center}

    /* Cards grid */
    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin:20px 0 8px}
    @media (max-width:1024px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:720px){.cards{grid-template-columns:1fr}}

    /* Card */
    .wc-card{
      background:var(--glass-strong);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--shadow);
      transition:transform .18s ease, border-color .18s ease, box-shadow .18s ease;
      outline-offset:3px;
      min-height: 258px; /* compact but consistent */
      display:flex;flex-direction:column;
    }
    .wc-card:hover{transform:translateY(-2px);border-color:var(--line-strong)}
    .wc-card.is-selected{border-color:var(--primary);box-shadow:0 10px 26px var(--ring)}

    /* Uniform top row */
    .wc-toggle{display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none}
    .avatar{
      width:60px;height:60px;border-radius:999px;border:2px solid var(--line);
      object-fit:cover;background:#fff;flex:0 0 auto;
    }
    .title-wrap{display:flex;flex-direction:column;gap:2px}
    .card-title{font-size:15px;font-weight:900;letter-spacing:.2px}
    .card-desc{font-size:12.5px;color:var(--muted);line-height:1.3}



    /* Sections */
    .wc-badge{letter-spacing:.12em;color:var(--muted);font-weight:800;font-size:11px}
    .wc-divider{height:1px;background:linear-gradient(90deg,transparent,var(--line),transparent);margin:.6rem 0}

    /* Skills pills */
    .wc-pill{padding:.34rem .66rem;border-radius:9999px;border:1px solid var(--line);background:#f6f9ff;font-size:.88rem;line-height:1;color:#2b3340;white-space:nowrap}
    .wc-pill.dim{opacity:.72}

    /* Apps row + plus tile */
    .logo-row{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 6px}
    .wc-app img{width:22px;height:22px;border-radius:6px;display:block;border:1px solid var(--line);background:#fff}
    .wc-app .fallback{width:22px;height:22px;border-radius:6px;display:grid;place-items:center;background:#eef3fb;border:1px solid var(--line);font-size:.7rem;color:#1b2a4a}
    .app-plus{
      width:22px;height:22px;border-radius:6px;border:1px dashed var(--line-strong);background:#fff;display:grid;place-items:center;color:#94a3b8;font-weight:900;cursor:pointer
    }
    .app-plus:hover{color:#1f2937;border-color:var(--primary);box-shadow:0 0 0 2px var(--ring) inset}

    /* KPIs & actions */
    .kpis{display:flex;flex-direction:column;gap:4px;margin:8px 0}
    .kpi{color:var(--success);font-weight:900}
    .actions{margin-top:auto}
    .btn{
      height:36px;padding:0 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--ink);font-weight:800;cursor:pointer
    }
    .btn:hover{box-shadow:var(--shadow-sm);border-color:var(--line-strong)}
    .btn.primary{background:var(--primary);color:var(--primary-ink);border-color:var(--primary)}
    .btn.primary.wide{width:100%}
    .used-by{margin-top:6px;color:var(--muted);font-size:12px}

    /* expandable area */
    .wc-more{height:0;overflow:hidden;opacity:0;transition:height .34s ease,opacity .24s ease;will-change:height}
    .wc-card[aria-expanded="true"] .wc-more{opacity:1}

    /* Footer */
    .footer-continue{display:flex;justify-content:center;gap:12px;margin:18px 0 38px}

    /* Modals */
    .modal-backdrop{position:fixed;inset:0;background:rgba(9,22,36,.32);display:none;align-items:center;justify-content:center;z-index:120;backdrop-filter:blur(3px)}
    .modal-backdrop.show{display:flex}
    .modal{
      width:min(760px,94vw);background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 24px 60px rgba(0,0,0,.18);overflow:hidden;color:var(--ink)
    }
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
    .modal .h3{font-weight:900}
    .modal .scroll{max-height:62vh;overflow:auto;padding:14px}
    .modal .close{background:transparent;border:0;font-size:20px;cursor:pointer}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-top:1px solid var(--line)}
    input,textarea{font:inherit;color:var(--ink)}
    .field{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}

    /* Apps picker */
    .apps-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media (max-width:860px){.apps-grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:560px){.apps-grid{grid-template-columns:repeat(2,1fr)}}
    .app-tile{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fdfdff;cursor:pointer;transition:transform .12s ease,border-color .2s ease, background .2s ease}
    .app-tile:hover{transform:translateY(-2px);border-color:var(--line-strong);background:#fff}
    .app-tile.selected{border-color:var(--primary);box-shadow:0 0 0 2px var(--ring) inset}
    .app-tile img{width:24px;height:24px;border-radius:6px;border:1px solid var(--line);background:#fff}
    .app-name{font-size:.95rem;color:var(--ink)}
    .search{width:100%;padding:10px 12px;border-radius:12px;background:#fff;border:1px solid var(--line);color:var(--ink);outline:none}
    .search:focus{border-color:var(--line-strong)}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-inner container">
      <div class="brand">
        <img src="logo.png" alt="Engini logo">
      </div>
      <div class="progress" aria-label="progress">
        <span class="active"><span class="dot"></span> Select Worker</span>
        <span>›</span>
        <span><span class="dot"></span> Select Skills</span>
        <span>›</span>
        <span><span class="dot"></span> Onboard</span>
        <span>›</span>
        <span><span class="dot"></span> Chat Workspace</span>
      </div>
      <button class="cta-sales" id="btnTalkSales">Talk to Sales</button>
    </div>
  </header>

  <!-- Modal: Talk to Sales -->
  <div id="salesModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="salesTitle">
    <div class="modal" onclick="event.stopPropagation()">
      <header>
        <div id="salesTitle" class="h3">Talk to Sales</div>
        <button class="close" onclick="closeModal('salesModal')">×</button>
      </header>
      <div class="scroll">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <input class="field" placeholder="Name">
          <input class="field" placeholder="Email">
          <input class="field" placeholder="Company">
          <input class="field" placeholder="Phone">
        </div>
        <textarea class="field" style="margin-top:10px;height:120px" placeholder="Tell us about your needs"></textarea>
      </div>
      <div class="row-between">
        <span class="muted">We’ll get back to you shortly.</span>
        <button class="btn primary" onclick="closeModal('salesModal')">Send</button>
      </div>
    </div>
  </div>

  <!-- Modal: Apps Picker -->
  <div id="appsModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="appsTitle">
    <div class="modal" onclick="event.stopPropagation()">
      <header>
        <div id="appsTitle" class="h3">Add Apps</div>
        <button class="close" onclick="closeModal('appsModal')">×</button>
      </header>
      <div class="scroll">
        <input id="appsSearch" class="search" placeholder="Search apps… (e.g., salesforce, zendesk, okta)"/>
        <div id="appsGrid" class="apps-grid" style="margin-top:12px"></div>
      </div>
      <div class="row-between">
        <span id="appsSelectionNote" class="muted">0 selected</span>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="closeModal('appsModal')">Cancel</button>
          <button id="appsAddBtn" class="btn primary">Add Selected</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Custom Worker -->
  <div id="customModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="customTitle">
    <div class="modal" onclick="event.stopPropagation()">
      <header>
        <div id="customTitle" class="h3">Create Your Custom Worker</div>
        <button class="close" onclick="closeModal('customModal')">×</button>
      </header>
      <div class="scroll">
        <div style="display:grid;grid-template-columns:1fr;gap:10px">
          <input id="cwName" class="field" placeholder="Worker name (e.g., Procurement Copilot)"/>
          <input id="cwDesc" class="field" placeholder="Short description (optional)"/>
        </div>
        <p class="muted" style="margin-top:10px">You can add skills on the next step and choose apps anytime.</p>
      </div>
      <div class="row-between">
        <span class="muted">We’ll start with an empty skill set.</span>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="closeModal('customModal')">Cancel</button>
          <button id="cwCreate" class="btn primary">Create & Continue</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Page Head -->
  <main class="container" id="appRoot">
    <h1 class="h1">Choose your AI Worker</h1>
    <p class="lead muted">Select the AI Worker that best fits your team's needs. Each worker comes with specialized skills and proven ROI metrics.</p>

    <!-- Cards Grid -->
    <div id="cards" class="cards"></div>

    <!-- Continue -->
    <div class="footer-continue">
      <button id="btnContinue" class="btn primary" disabled>Continue</button>
    </div>
  </main>

  <!-- Modal: Skills viewer -->
  <div id="skillsModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="skillsTitle">
    <div class="modal" onclick="event.stopPropagation()">
      <header>
        <div id="skillsTitle" class="h3">All Skills</div>
        <button class="close" onclick="closeModal('skillsModal')">×</button>
      </header>
      <div id="skillsBody" class="scroll"></div>
    </div>
  </div>

  <script>
    // ---------- Data (apps use /icons/<key>.png) ----------
    const WORKERS = [
      {
        id:'procurement', first:'Sarah',
        avatar:'sarah.png',
        desc:'Automates invoice intake, PO matching, supplier ops.',
        adoption:1842,
        apps:['quickbooks','netsuite','slack'],
        roi:['Invoice cycle time ↓35–55%','First-time match rate ↑20–35%'],
        skills14:[
          'Invoice capture (OCR/EDI)','Duplicate supplier/invoice detection','2/3-Way Match (Invoice ↔ PO ↔ GR)','PO & supplier validation',
          'GL / cost center coding','Tax/VAT compliance checks','Exception flagging & routing','Payment proposal creation',
          'Execute supplier payments','Vendor statement reconciliation','Contract renewal monitoring',
          'Supplier performance tracking','Policy enforcement','Audit-ready AP reporting'
        ]
      },
      {
        id:'finance', first:'David',
        avatar:'david.png',
        desc:'Month-end close, reconciliations, reporting.',
        adoption:1376,
        apps:['netsuite','sap','sage','quickbooks','xero','oracle'],
        roi:['Month-end close time ↓20–30%','Reconciliation STP ↑60–80%'],
        skills14:[
          'Bank reconciliation','Recurring journal entries','Month-end data consolidation','Accruals & reclasses','AP/AR aging reports',
          'Expense anomaly detection','Cash flow forecasting','Trial balance drafts','VAT/GST reporting','P&L by cost center',
          'Payment batch scheduling','Payroll to GL integration','Variance analysis','DSO/DPO/OPEX KPI tracking'
        ]
      },
      {
        id:'hr', first:'Selina',
        avatar:'selina.png',
        desc:'Onboarding, HR tickets, access & records.',
        adoption:1109,
        apps:['workday','bamboo','hibob','ukg'],
        roi:['Ticket deflection ↑30–50%','Onboarding time ↓40–60%'],
        skills14:[
          'New-hire onboarding (accounts/systems)','HRIS record creation','Access provisioning/deprovisioning','PTO/leave automation',
          'Payslip/tax form generation','Compliance training reminders','HR ticket FAQ resolution','Performance review reminders',
          'Training completion tracking','Org chart updates','Headcount & attrition reports','Benefits enrollment',
          'Expense reimbursement processing','HR policy compliance checks'
        ]
      },
      {
        id:'it', first:'Max',
        avatar:'max.png',
        desc:'Ticket triage, resets, provisioning, patching, onboarding.',
        adoption:2204,
        apps:['servicenow','jira','okta','intune','jamf'],
        roi:['Auto-resolution ↑40–60%','MTTR ↓25–40%'],
        skills14:[
          'Auto-triage incoming tickets','Password resets','Account unlocks','Incident categorization/prioritization',
          'Close duplicates/low-value tickets','Software package deployment','Security patching','User provisioning/deprovisioning',
          'Intelligent ticket routing','SLA/MTTR KPI reporting','Asset inventory maintenance','Compliance/security scans',
          'Weekly IT ops reports','Uptime/alert monitoring'
        ]
      },
      {
        id:'aml', first:'Jacob',
        avatar:'jacob.png',
        desc:'Sanctions/PEP, TM, KYC/KYB, EDD, narratives.',
        adoption:987,
        apps:['sas','lseg','oracle','zip','basware'],
        roi:['Alert auto-clearance ↑60–80%','False positives ↓50–70%'],
        skills14:[
          'Sanctions/PEP Alert Triage','False-positive suppression','Payments sanctions screening',
          'AML transaction monitoring (L1 review)','KYC/KYB onboarding docs','Entity resolution & de-duplication',
          'Watchlist/data enrichment','Adverse media monitoring','Case assembly & EDD pack',
          'Risk scoring & KYC refresh','Narrative generation (GenAI)','SAR/STR drafting assist',
          'Quality assurance & audit trail','Workload prioritization & SLA'
        ]
      },
      {
        id:'custom', first:'Custom Worker',
        avatar:'custom.png',
        desc:'Build your “dream worker” tailored to your stack.',
        adoption:null,
        apps:[],
        roi:['Per use case'],
        skills14:[]
      }
    ];

    const AVAILABLE_APPS = [
      'servicenow','okta','google','slack','microsoft','quickbooks','netsuite','jira','workday','salesforce',
      'hubspot','zendesk','intercom','mailchimp','marketo','outreach','xero','bamboo','hibob','ukg',
      'intune','jamf','coupa','tipalti','ariba','zip','basware','oracle','sap','lseg','sas'
    ];

    const LS = { WORKER:'engini.selectedWorker' };
    const LS_APPS_PREFIX = 'engini.apps.'; // per-worker added apps

    const cardsRoot   = document.getElementById('cards');
    const btnContinue = document.getElementById('btnContinue');
    document.getElementById('btnTalkSales').onclick = () => openModal('salesModal');

    function openModal(id){ document.getElementById(id).classList.add('show'); }
    function closeModal(id){ document.getElementById(id).classList.remove('show'); }
    function getSavedWorker(){ try{ return JSON.parse(localStorage.getItem(LS.WORKER)||'null'); }catch{return null;} }
    function saveWorker(w){ localStorage.setItem(LS.WORKER, JSON.stringify(w)); }

    const saved = getSavedWorker();
    let selectedId = saved?.id || null;

    // Merge saved added apps into WORKERS on boot
    function hydrateApps(){
      WORKERS.forEach(w=>{
        try{
          const saved = JSON.parse(localStorage.getItem(LS_APPS_PREFIX + w.id) || '[]');
          if(Array.isArray(saved) && saved.length){
            const base = new Set([...(w.apps||[]), ...saved]);
            w.apps = Array.from(base);
          }
        }catch{}
      });
    }

    // helpers
    const initials = (txt="") => (txt||"?").trim().slice(0,2).toUpperCase();
    const pill  = (t,dim=false)=>`<span class="wc-pill ${dim?'dim':''}">${t}</span>`;
    const niceName = (key)=> key.replace(/[-_]/g,' ').replace(/\b\w/g,m=>m.toUpperCase());
    const appPath  = (key)=> `icons/${key}.png`;

    function appIcon(key){
      return `
        <span class="wc-app">
          <img src="${appPath(key)}" alt="${key}"
               onerror="this.parentElement.outerHTML='<span class=&quot;wc-app&quot;><span class=&quot;fallback&quot;>${(key||'?').slice(0,2).toUpperCase()}</span></span>'"/>
        </span>`;
    }

    function personPhotoSrc(w){
      const guess = (w.first||w.title||'worker').toLowerCase() + '.png';
      return { guess, fallback: w.avatar };
    }

    function cardTemplate(w){
      const primary = (w.skills14||[]).slice(0,4).map(s=>pill(s)).join("");
      const extra   = (w.skills14||[]).slice(4,7).map(s=>pill(s,true)).join("");

      const name  = w.first || w.title;
      const photo = personPhotoSrc(w);
      const usedBy = w.adoption ? `<div class="used-by">Used by ${w.adoption.toLocaleString()}+ users</div>` : '';

      const appsRow = (w.apps||[]).map(k=>appIcon(k)).join("") +
        `<button class="app-plus" data-addapps="${w.id}" title="Add apps" aria-label="Add apps to ${name}">+</button>`;

      return `
      <article class="wc-card ${selectedId===w.id?'is-selected':''}" data-id="${w.id}" aria-expanded="false">
        <header class="wc-toggle">
          <img src="${photo.guess}" alt="${name}" class="avatar"
               onerror="
                 if(this.dataset.triedFallback!=='1' && '${photo.fallback||''}'){
                   this.src='${photo.fallback}'; this.dataset.triedFallback='1';
                 }else{
                   const d=document.createElement('div');d.className='avatar';d.style.display='grid';d.style.placeItems='center';d.style.fontWeight='900';d.textContent='${initials(name)}';
                   this.replaceWith(d);
                 }
               " />
          <div class="title-wrap">
            <div class="card-title">${name}</div>
            <div class="card-desc">${w.desc || ''}</div>
          </div>
        
        </header>

        <div class="wc-divider"></div>
        <div class="wc-badge">AI SKILLS</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px">${primary || '<span class="muted">No skills listed</span>'}</div>
        ${extra ? `<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px">${extra}</div>` : ''}

        ${w.id!=='custom' ? `
          <div style="margin-top:8px">
            <button class="btn" data-view="${w.id}">View all skills</button>
          </div>` : `
          <div class="muted" style="margin-top:8px">Start from templates or design a worker end-to-end.</div>
        `}

        <div class="wc-divider" style="margin-top:10px"></div>
        <div class="wc-badge">APPS</div>
        <div class="logo-row">${appsRow}</div>

        <div class="kpis">${(w.roi||[]).map(k=>`<div class="kpi">${k}</div>`).join('')}</div>

        <div class="actions">
          <button class="btn primary wide" data-onboard="${w.id}">${w.id==='custom' ? 'Build your dream worker' : 'On-Board'}</button>
          ${usedBy}
        </div>

        <section class="wc-more" style="margin-top:10px;padding-top:10px;border-top:1px solid var(--line)">
          <p class="muted" style="margin:0 0 6px">${w.more?.summary || '—'}</p>
          ${(w.more?.playbooks?.length
            ? `<div style="margin-top:8px">
                 <div class="wc-badge" style="margin-bottom:6px">Playbooks</div>
                 <div style="display:flex;flex-wrap:wrap;gap:8px">
                   ${(w.more.playbooks||[]).map(p=>pill(p)).join('')}
                 </div>
               </div>` : ''
          )}
        </section>
      </article>`;
    }

    function renderCards(){
      cardsRoot.innerHTML = WORKERS.map(cardTemplate).join('');
      document.querySelectorAll('.wc-card').forEach(card=>{
        const id = card.getAttribute('data-id');
        const section = card.querySelector('.wc-more');
        const header  = card.querySelector('.wc-toggle');

        // collapsed initial
        section.style.height = "0px"; section.style.opacity = "0";

        header.addEventListener('click', (e)=>{
          e.stopPropagation();
          toggleExpand(card, section);
        });

        // Select card when clicking empty area
        card.addEventListener('click', (e)=>{
          if (e.target.closest('button') || e.target.closest('.wc-toggle') || e.target.closest('.logo-row')) return;
          selectWorkerById(id);
        });

        // On-Board
        card.querySelector(`[data-onboard="${id}"]`)?.addEventListener('click', (e)=>{
          e.stopPropagation();
          if(id==='custom'){
            openModal('customModal'); // create custom worker first
            return;
          }
          selectWorkerById(id);
          goToStep2();
        });

        // View all skills
        card.querySelector(`[data-view="${id}"]`)?.addEventListener('click', (e)=>{
          e.stopPropagation();
          const w = WORKERS.find(x=>x.id===id);
          openSkillsModal(w);
        });

        // Add apps (plus tile)
        card.querySelector(`[data-addapps="${id}"]`)?.addEventListener('click',(e)=>{
          e.stopPropagation();
          openAppsModal(id);
        });
      });

      btnContinue.disabled = !selectedId;
    }

    function toggleExpand(card,section){
      const isOpen = card.getAttribute("aria-expanded")==="true";
      if(isOpen){
        section.style.height = section.scrollHeight + "px"; section.getBoundingClientRect();
        section.style.height = "0px"; section.style.opacity = "0"; card.setAttribute("aria-expanded","false");
      }else{
        section.style.height = "0px"; section.style.opacity = "1"; card.setAttribute("aria-expanded","true");
        const target = section.scrollHeight; section.style.height = target + "px";
        const onEnd=(ev)=>{if(ev.propertyName!=="height") return; section.style.height="auto"; section.removeEventListener("transitionend", onEnd);};
        section.addEventListener("transitionend", onEnd);
      }
    }

    function selectWorkerById(id){
      const w = WORKERS.find(x=>x.id===id);
      if(!w) return;
      selectedId = w.id;

      // save avatar for the skills page to inherit
      const avatarUrl = w.avatar || ((w.first || w.title || 'worker').toLowerCase() + '.png');
      localStorage.setItem('engini.workerAvatar', JSON.stringify(avatarUrl));

      saveWorker({ id:w.id, name:w.first || w.title || 'AI Worker' });
      renderCards();
    }

    btnContinue.addEventListener('click', goToStep2);
    function goToStep2(){
      if(!selectedId) return;
      window.location.href = 'skills.html';
    }

    // View all skills modal
    function openSkillsModal(worker){
      const body = document.getElementById('skillsBody');
      const title = document.getElementById('skillsTitle');
      title.textContent = `${worker.first || worker.title} — All Skills`;
      const allSkills = worker.skills14 || [];
      body.innerHTML = allSkills.length
        ? `<ul style="padding-left:18px;margin:0">${allSkills.map(s=>`<li>${s}</li>`).join('')}</ul>`
        : `<p class="muted">No predefined skills. Use the Custom Worker flow in the next step.</p>`;
      openModal('skillsModal');
    }

    // ===== Apps Picker =====
    let _appsModalWorkerId = null;
    let _appsSelected = new Set();

    function openAppsModal(workerId){
      _appsModalWorkerId = workerId;
      _appsSelected.clear();
      document.getElementById("appsTitle").textContent = "Add Apps";
      document.getElementById("appsSelectionNote").textContent = "0 selected";
      document.getElementById("appsSearch").value = "";
      buildAppsGrid();
      openModal('appsModal');
    }

    function buildAppsGrid(){
      const grid = document.getElementById("appsGrid");
      const w = WORKERS.find(x=>x.id===_appsModalWorkerId);
      const owned = new Set([...(w.apps||[])]);

      const query = document.getElementById("appsSearch").value.trim().toLowerCase();
      const list = AVAILABLE_APPS.filter(k=>{
        if(owned.has(k)) return false;
        if(!query) return true;
        const display = k.toLowerCase().replace(/[-_]/g,' ');
        return k.includes(query) || display.includes(query);
      });

      grid.innerHTML = list.map(k=>`
        <div class="app-tile" data-app="${k}">
          <img src="${appPath(k)}" alt="${k}" onerror="this.style.display='none'"/>
          <div class="app-name">${niceName(k)}</div>
        </div>
      `).join("");

      grid.querySelectorAll(".app-tile").forEach(tile=>{
        tile.addEventListener("click", ()=>{
          const key = tile.getAttribute("data-app");
          if(_appsSelected.has(key)){ _appsSelected.delete(key); tile.classList.remove("selected"); }
          else { _appsSelected.add(key); tile.classList.add("selected"); }
          document.getElementById("appsSelectionNote").textContent = `${_appsSelected.size} selected`;
        });
      });
    }

    document.getElementById("appsSearch").addEventListener("input", buildAppsGrid);

    document.getElementById("appsAddBtn").addEventListener("click", ()=>{
      if(!_appsModalWorkerId || _appsSelected.size===0){ closeModal('appsModal'); return; }
      const w = WORKERS.find(x=>x.id===_appsModalWorkerId);
      if(!w) return;

      const base = new Set(w.apps || []);
      _appsSelected.forEach(k=> base.add(k));
      w.apps = Array.from(base);

      try{
        const existing = JSON.parse(localStorage.getItem(LS_APPS_PREFIX + w.id) || '[]');
        const merged = Array.from(new Set([...(existing||[]), ...Array.from(_appsSelected)]));
        localStorage.setItem(LS_APPS_PREFIX + w.id, JSON.stringify(merged));
      }catch{}

      closeModal('appsModal');
      renderCards();
    });

    // ===== Custom Worker flow =====
    const cwName  = document.getElementById('cwName');
    const cwDesc  = document.getElementById('cwDesc');
    const cwCreate= document.getElementById('cwCreate');

    cwCreate.addEventListener('click', ()=>{
      const name = (cwName.value || 'Custom Worker').trim();
      const desc = (cwDesc.value || 'Tailored to your stack.').trim();

      // Update the "custom" worker in-memory, save selection, continue
      const w = WORKERS.find(x=>x.id==='custom');
      if(w){
        w.first = name;
        w.desc  = desc;
        // Reset any prior custom apps/skills if needed
        try{ localStorage.removeItem(LS_APPS_PREFIX + 'custom'); }catch{}
      }

      // Save avatar + selection for skills page
      const avatarUrl = w.avatar || 'custom.png';
      localStorage.setItem('engini.workerAvatar', JSON.stringify(avatarUrl));
      selectedId = 'custom';
      saveWorker({ id:'custom', name });

      closeModal('customModal');
      goToStep2();
    });

    // Boot
    (function init(){
      hydrateApps();
      renderCards();
    })();
  </script>
</body>
</html>
